{% extends "base.html" %}
{% load price_filters  %}
{% load static %}

{% block content %}

<body>
<div class="product-layout">

  {% include "catalog/includes/breadcrumbs.html" %}

  <h1 class="product-h1">{{ product.name }}</h1>

  <div class="product-wrapper">
    <!-- Галерея слева -->
    <aside class="product-gallery">
      <div class="gallery-thumbs">
          {% with images=product.images.all %}
            {% if images %}
                {% for img in images %}
                    <img src="{{ img.image.url }}"
                         class="gallery-thumb {% if img.is_main %}active{% endif %}"
                         data-large="{{ img.image.url }}"
                         alt="{{ product.name }} - фото">
                 {% endfor %}
            {% else %}
                <img src="{{ default_image }}"
                    class="gallery-thumb active"
                    alt="Нет изображения">
            {% endif %}
          {% endwith %}
      </div>

      <div class="gallery-main">
          {% with main_img=product.main_image %}
            {% if main_img %}
                <img src="{{ main_img.url }}"
                    alt="{{ product.name }}"
                    class="gallery-main-img"
                    id="mainProductImg">
            {% else %}
                <img src="{{ default_image }}"
                    class="gallery-main-img"
                    alt="Нет изображения"
                    id="mainProductImg">
            {% endif %}
          {% endwith %}
      </div>
    </aside>

    <!-- Информация и правая колонка -->
    <section class="product-info-section">

      <div class="product-top-block">
        <div class="product-props">
          <div>{{ product.description|linebreaks }}</div>
        </div>
      </div>

        <div class="products-purchase-row">
                <div class="product-price-row">
                    {% with old_price=product.get_old_price %}
                        {% if old_price %}
                            <span class="price-current">{{ product.price | format_price }} ₽</span>
                            <span class="price-old">{{ old_price | format_price }} ₽</span>
                            <span class="price-current">-{{ product.get_discount_percent }}%</span>
                        {% else %}
                            <span class="price-current">{{ product.price | format_price }} ₽</span>
                        {% endif %}
                    {% endwith %}
                </div>

      <div class="product-buy-row">
        <form method="post" action="{% url 'cart:add' product_id=product.pk %}">
          {% csrf_token %}
          <button type="submit" class="buy-btn">Купить</button>
        </form>
{##}
            <button class="fav-btn favorite-toggle-btn {% if product.id in wishlist_products %} is-fav {% endif %}"
                data-product-id="{{ product.id }}"
                data-url="{% url 'wishlist:add' product.id %}">
                &#10084;
            </button>
      </div>
{##}
      <div class="product-extra-blocks">
        <span class="in-stock">
          {% if product.stock_quantity %}
            В наличии
          {% else %}
            Нет в наличии
          {% endif %}
        </span>
      </div>
    </section>
  </div>
</div>
</body>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Находим все миниатюры
  const thumbnails = document.querySelectorAll('.gallery-thumb');
  // Находим главное изображение по ID
  const mainImg = document.getElementById('mainProductImg');

  if (thumbnails.length > 0 && mainImg) {
    thumbnails.forEach(function(thumb) {
      thumb.addEventListener('click', function() {
        // Получаем URL большого изображения из data-атрибута
        const largeImageUrl = this.dataset.large;

        if (largeImageUrl) {
          // Меняем src главного изображения
          mainImg.src = largeImageUrl;

          // Убираем класс active у всех миниатюр
          thumbnails.forEach(function(img) {
            img.classList.remove('active');
          });

          // Добавляем класс active текущей миниатюре
          this.classList.add('active');
        }
      });
    });
  } else {
    console.error('Галерея: не найдены миниатюры или главное изображение');
  }
});
</script>


{% csrf_token %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const favBtn = document.querySelector('.favorite-toggle-btn');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (favBtn) {
        favBtn.addEventListener('click', function(e) {
            e.preventDefault();

            const url = this.dataset.url;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.redirected) {
                    // Если перенаправляет на страницу входа
                    window.location.href = response.url;
                } else {
                    // Переключаем класс is-fav
                    this.classList.toggle('is-fav');

                    // Можно показать уведомление
                    console.log('Избранное обновлено');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
            });
        });
    }
});
</script>


{% endblock %}